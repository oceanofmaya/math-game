<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Math Game</title>
    <meta name="keywords" content="Math,Game" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="EN" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="version" content="1.1.5" />

    <link rel="icon" type="image/x-icon" href="favicon.ico" />

    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/visual-themes/jellyfish.css" />
    <link rel="stylesheet" type="text/css" href="css/visual-themes/firefly.css" />
    <link rel="stylesheet" type="text/css" href="css/visual-themes/pearl.css" />
    <link rel="stylesheet" type="text/css" href="css/visual-themes/mushroom.css" />
    <link rel="stylesheet" type="text/css" href="css/visual-themes/maple.css" />

    <script src="js/constants.js"></script>
    <script src="js/sound-manager.js"></script>
    <script src="js/visual-themes/base-theme.js"></script>
    <script src="js/visual-themes/manager.js"></script>
    <script src="js/visual-themes/jellyfish.js"></script>
    <script src="js/visual-themes/firefly.js"></script>
    <script src="js/visual-themes/pearl.js"></script>
    <script src="js/visual-themes/mushroom.js"></script>
    <script src="js/visual-themes/maple.js"></script>
    <script src="js/scripts.js"></script>
  </head>

  <body>
    <div id="version-display" class="version-display" aria-hidden="true"></div>
    <!-- Live region for screen reader announcements -->
    <div id="ariaLiveRegion" aria-live="polite" aria-atomic="true" class="sr-only"></div>
    <form id="gameForm" onsubmit="event.preventDefault();" role="main" aria-label="Math Game">
      <h1>Math Game</h1>
      <div class="flex-container count-container" role="status" aria-label="Score">
        <div>Correct:&nbsp;<span id="countCorrect" class="success" aria-label="Correct answers">0</span></div>
        <div>&nbsp;Wrong:&nbsp;<span id="countWrong" class="fail" aria-label="Wrong answers">0</span></div>
        <div>&nbsp;Skipped:&nbsp;<span id="countSkip" class="skip" aria-label="Skipped questions">0</span></div>
        <div id="timerContainer" class="hidden">
          <span>&nbsp;Time:&nbsp;</span>
          <span id="timerDisplay" aria-label="Time remaining">0:00</span>
        </div>
      </div>
      <div class="flex-container flex-direction-column">
        <div>
          <fieldset>
            <legend>Mode</legend>
            <div class="mode-toggle-container" role="toolbar" aria-label="Game controls">
              <button type="button" id="gameModeButton" class="mode-button" aria-label="Game mode" aria-pressed="true">
                Game
              </button>
              <button
                type="button"
                id="sampleModeButton"
                class="mode-button inactive"
                aria-label="Sample mode"
                aria-pressed="false"
              >
                Sample
              </button>
              <span class="separator" aria-hidden="true">|</span>
              <button
                type="button"
                id="musicToggleButton"
                class="mode-button"
                title="Toggle theme music"
                aria-label="Toggle theme music"
                aria-pressed="false"
              >
                ♪
              </button>
              <button
                type="button"
                id="helpToggle"
                class="mode-button help-toggle-button"
                title="Show/Hide How to Play"
                aria-label="Show help information"
                aria-expanded="false"
                aria-controls="helpContent"
              >
                ?
              </button>
              <span class="separator" aria-hidden="true">|</span>
              <button
                type="button"
                id="timedModeButton"
                class="mode-button inactive"
                title="Toggle timed mode"
                aria-label="Toggle timed mode"
                aria-pressed="false"
              >
                ⏱
              </button>
            </div>
          </fieldset>
          <fieldset id="helpContent" class="help-content hidden">
            <legend id="helpLegend">How to Play</legend>
            <div id="helpTextGame" class="help-text">
              <p><strong>Quick Start:</strong> Select a theme, then start answering math problems!</p>
              <p>
                <strong>Visual Effects:</strong> Correct answers create visual elements. They start grayscale and become
                colorful as you progress. More correct answers unlock pulse and wave effects.
              </p>
              <p>
                <strong>Operations:</strong> Choose a specific operation (+, −, ×, ÷) or select <strong>±</strong> for
                Mixed Operations mode, which randomly selects from all four operations for each question.
              </p>
              <p><strong>Max Number:</strong> Sets the difficulty range (1-999), but varies by operation:</p>
              <ul class="help-list">
                <li><strong>+</strong> and <strong>×</strong>: Both numbers from 1 to max</li>
                <li><strong>−</strong>: First number 1 to max, second ≤ first (no negatives)</li>
                <li><strong>÷</strong>: Divisor 1 to max, dividend up to max² (whole numbers only)</li>
              </ul>
              <p>
                <strong>Skip vs Wrong:</strong> Both remove visual elements. Use Skip when you don't know the answer;
                Wrong is for incorrect submissions.
              </p>
              <p>
                <strong>Timed Mode:</strong> Click the ⏱ button to start a 5-minute timed session. The timer begins
                immediately and counts down. Answer as many questions as possible before time runs out. Click the ⏱
                button again to stop the timer and reset. Your timed session results will be shown when the timer ends.
              </p>
            </div>
            <div id="helpTextSample" class="help-text hidden">
              <p><strong>Purpose:</strong> Test visual themes without playing the game.</p>
              <p>
                <strong>Controls:</strong> Select theme and element count, then use buttons to test effects: Birth
                (create), Age (colorize), Color, Pulse, Color Wave, End (remove), Reset.
              </p>
              <p><strong>Tip:</strong> Click "Birth" after changing element count to apply changes.</p>
            </div>
          </fieldset>
        </div>
        <div class="game-mode-fields">
          <div>
            <fieldset>
              <legend>Theme</legend>
              <label for="visualThemeSelect" class="sr-only">Select visual theme</label>
              <select id="visualThemeSelect" aria-label="Select visual theme">
                <option value="" selected disabled>Choose...</option>
                <option value="firefly">Firefly</option>
                <option value="jellyfish">Jellyfish</option>
                <option value="pearl">Pearl</option>
                <option value="mushroom">Mushroom</option>
                <option value="maple">Maple</option>
              </select>
            </fieldset>
          </div>
          <fieldset id="visualHint">
            <legend>Effects</legend>
            <!-- Visual effects status content will appear here -->
          </fieldset>
        </div>
        <div id="sampleModeFields" class="hidden">
          <div>
            <fieldset>
              <legend>Theme</legend>
              <label for="visualThemeSelectSample" class="sr-only">Select visual theme for sample mode</label>
              <select id="visualThemeSelectSample" aria-label="Select visual theme for sample mode">
                <option value="" selected disabled>Choose...</option>
                <option value="firefly">Firefly</option>
                <option value="jellyfish">Jellyfish</option>
                <option value="pearl">Pearl</option>
                <option value="mushroom">Mushroom</option>
                <option value="maple">Maple</option>
              </select>
            </fieldset>
          </div>
          <fieldset>
            <legend>Theme Controls</legend>
            <div class="sample-controls-container">
              <div class="sample-element-label">
                <span class="sample-element-label-text">Elements:</span>
                <label for="sampleElementCount" class="sr-only">Number of visual elements</label>
                <select id="sampleElementCount" class="sample-element-select" aria-label="Number of visual elements">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5" selected>5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="20">20</option>
                </select>
              </div>
              <div class="sample-element-hint">Click "Birth" to create elements</div>
              <div class="sample-lifecycle-hint">Lifecycle progression (top to bottom):</div>
              <button type="button" id="sampleBirth" class="sample-button" aria-label="Create visual elements">
                Birth
              </button>
              <button
                type="button"
                id="sampleAge"
                class="sample-button-secondary"
                aria-label="Remove grayscale filter from elements"
              >
                Age (Remove Grayscale)
              </button>
              <button
                type="button"
                id="sampleColor"
                class="sample-button-secondary"
                aria-label="Apply color to elements"
              >
                Color
              </button>
              <button type="button" id="samplePulse" class="sample-button-secondary" aria-label="Apply pulse animation">
                Pulse
              </button>
              <button
                type="button"
                id="sampleColorWave"
                class="sample-button-secondary"
                aria-label="Apply color wave effect"
              >
                Color Wave
              </button>
              <button type="button" id="sampleEnd" class="sample-button-secondary" aria-label="Remove elements">
                End
              </button>
              <button type="button" id="sampleReset" class="sample-button-reset" aria-label="Reset all visual elements">
                Reset
              </button>
            </div>
          </fieldset>
        </div>
        <div class="game-mode-fields">
          <fieldset>
            <legend>Operation</legend>
            <div class="operation-selector" role="group" aria-label="Math operation">
              <input
                type="button"
                class="operation-btn"
                id="op-add"
                value="+"
                title="Addition"
                aria-label="Addition"
                aria-pressed="false"
              />
              <input
                type="button"
                class="operation-btn"
                id="op-subtract"
                value="−"
                title="Subtraction"
                aria-label="Subtraction"
                aria-pressed="false"
              />
              <input
                type="button"
                class="operation-btn active"
                id="op-multiply"
                value="×"
                title="Multiplication"
                aria-label="Multiplication"
                aria-pressed="true"
              />
              <input
                type="button"
                class="operation-btn"
                id="op-divide"
                value="÷"
                title="Division"
                aria-label="Division"
                aria-pressed="false"
              />
              <span class="separator" aria-hidden="true">|</span>
              <input
                type="button"
                class="operation-btn"
                id="op-mixed"
                value="±"
                title="Mixed Operations"
                aria-label="Mixed Operations (random)"
                aria-pressed="false"
              />
              <span class="separator" aria-hidden="true">|</span>
              <input
                type="button"
                class="operation-btn"
                id="op-reset"
                value="↺"
                title="Reset Counts"
                aria-label="Reset score counts"
              />
            </div>
          </fieldset>
        </div>
        <div class="game-mode-fields">
          <fieldset>
            <legend>
              <span id="number1" aria-label="First number"></span>
              <span id="operationSymbol" aria-hidden="true">&nbsp;×&nbsp;</span>
              <span id="number2" aria-label="Second number"></span>
            </legend>
            <label for="answer" class="sr-only">Enter your answer</label>
            <input
              id="answer"
              type="number"
              placeholder="Answer"
              autofocus
              aria-label="Enter your answer"
              aria-required="true"
            />
            <div class="button-container">
              <input type="submit" id="submitAnswer" value="✓" title="Submit answer" aria-label="Submit answer" />
              <input type="button" id="skipQuestion" value="⏭" title="Skip question" aria-label="Skip this question" />
            </div>
            <div id="answerMessage" role="status" aria-live="polite" aria-atomic="true">
              <!-- answer message is going to go here -->
            </div>
          </fieldset>
        </div>
        <div class="game-mode-fields">
          <fieldset>
            <legend>Max Number</legend>
            <label for="maxNumber" class="sr-only">Maximum number for problems</label>
            <input
              id="maxNumber"
              type="number"
              value="20"
              placeholder="Number"
              aria-label="Maximum number for problems"
              min="1"
              max="999"
            />
            <div class="button-container">
              <input
                type="button"
                id="changeMaxNumber"
                value="↻"
                title="Change maximum number"
                aria-label="Apply maximum number change"
              />
            </div>
          </fieldset>
        </div>
      </div>
    </form>

    <script type="text/javascript">
      // Initialize event handlers after DOM is ready
      document.addEventListener('DOMContentLoaded', function () {
        const Constants = OceanOfMaya.Constants;

        // Reset max number input to default
        const maxNumberInput = document.getElementById('maxNumber');
        if (maxNumberInput) {
          maxNumberInput.value = Constants.DEFAULT_MAX_NUMBER.toString();
        }

        // Initialize sample element count dropdown based on game capacity
        // This will be updated by VisualThemes.Manager.updateSampleElementDropdown()
        // after the manager is initialized

        // Mode toggle buttons
        const gameButton = document.getElementById('gameModeButton');
        const sampleButton = document.getElementById('sampleModeButton');

        // Help content elements (needed for updateHelpContent function)
        const helpTextGame = document.getElementById('helpTextGame');
        const helpTextSample = document.getElementById('helpTextSample');
        const helpLegend = document.getElementById('helpLegend');

        // Function to update help content based on current mode
        function updateHelpContent() {
          const isSampleMode = sampleButton && sampleButton.classList.contains('active');
          if (helpTextGame && helpTextSample) {
            if (isSampleMode) {
              helpTextGame.classList.add('hidden');
              helpTextSample.classList.remove('hidden');
              if (helpLegend) {
                helpLegend.textContent = 'Sample Mode';
              }
            } else {
              helpTextGame.classList.remove('hidden');
              helpTextSample.classList.add('hidden');
              if (helpLegend) {
                helpLegend.textContent = 'How to Play';
              }
            }
          }
        }

        // Helper function to add keyboard support to buttons
        function addKeyboardSupport(button, clickHandler) {
          if (button) {
            button.addEventListener('click', clickHandler);
            button.addEventListener('keydown', function (e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                clickHandler();
              }
            });
          }
        }

        if (gameButton && sampleButton) {
          // Game mode button handler
          addKeyboardSupport(gameButton, function () {
            if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
              OceanOfMaya.VisualThemes.Manager.setMode('game');
            }
            gameButton.setAttribute('aria-pressed', 'true');
            sampleButton.setAttribute('aria-pressed', 'false');
            // Update help content if it's currently visible
            setTimeout(function () {
              if (helpContent && !helpContent.classList.contains('hidden')) {
                updateHelpContent();
              }
            }, 0);
          });
          // Sample mode button handler
          addKeyboardSupport(sampleButton, function () {
            if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
              OceanOfMaya.VisualThemes.Manager.setMode('sample');
            }
            gameButton.setAttribute('aria-pressed', 'false');
            sampleButton.setAttribute('aria-pressed', 'true');
            // Update help content if it's currently visible
            setTimeout(function () {
              if (helpContent && !helpContent.classList.contains('hidden')) {
                updateHelpContent();
              }
            }, 0);
          });
        }

        // Sample mode controls
        const sampleBirth = document.getElementById('sampleBirth');
        const sampleAge = document.getElementById('sampleAge');
        const sampleColor = document.getElementById('sampleColor');
        const samplePulse = document.getElementById('samplePulse');
        const sampleColorWave = document.getElementById('sampleColorWave');
        const sampleEnd = document.getElementById('sampleEnd');
        const sampleReset = document.getElementById('sampleReset');

        addKeyboardSupport(sampleBirth, function () {
          if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
            OceanOfMaya.VisualThemes.Manager.sampleBirth();
          }
        });
        addKeyboardSupport(sampleAge, function () {
          if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
            OceanOfMaya.VisualThemes.Manager.sampleAge();
          }
        });
        addKeyboardSupport(sampleColor, function () {
          if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
            OceanOfMaya.VisualThemes.Manager.sampleColor();
          }
        });
        addKeyboardSupport(samplePulse, function () {
          if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
            OceanOfMaya.VisualThemes.Manager.samplePulse();
          }
        });
        addKeyboardSupport(sampleColorWave, function () {
          if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
            OceanOfMaya.VisualThemes.Manager.sampleColorWave();
          }
        });
        addKeyboardSupport(sampleEnd, function () {
          if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
            OceanOfMaya.VisualThemes.Manager.sampleEnd();
          }
        });
        addKeyboardSupport(sampleReset, function () {
          if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
            OceanOfMaya.VisualThemes.Manager.sampleReset();
          }
        });

        // Theme selectors
        const themeSelect = document.getElementById('visualThemeSelect');
        const themeSelectSample = document.getElementById('visualThemeSelectSample');

        if (themeSelect) {
          themeSelect.addEventListener('change', function () {
            if (OceanOfMaya.MathGame) {
              OceanOfMaya.MathGame.changeVisualTheme();
            }
          });
        }

        if (themeSelectSample) {
          themeSelectSample.addEventListener('change', function () {
            if (OceanOfMaya.MathGame) {
              OceanOfMaya.MathGame.changeVisualTheme();
            }
          });
        }

        // Operation buttons
        const opAdd = document.getElementById('op-add');
        const opSubtract = document.getElementById('op-subtract');
        const opMultiply = document.getElementById('op-multiply');
        const opDivide = document.getElementById('op-divide');
        const opMixed = document.getElementById('op-mixed');
        const opReset = document.getElementById('op-reset');

        if (opAdd)
          opAdd.addEventListener('click', function () {
            if (OceanOfMaya.MathGame) OceanOfMaya.MathGame.setOperation('add');
          });
        if (opSubtract)
          opSubtract.addEventListener('click', function () {
            if (OceanOfMaya.MathGame) OceanOfMaya.MathGame.setOperation('subtract');
          });
        if (opMultiply)
          opMultiply.addEventListener('click', function () {
            if (OceanOfMaya.MathGame) OceanOfMaya.MathGame.setOperation('multiply');
          });
        if (opDivide)
          opDivide.addEventListener('click', function () {
            if (OceanOfMaya.MathGame) OceanOfMaya.MathGame.setOperation('divide');
          });
        if (opMixed)
          opMixed.addEventListener('click', function () {
            if (OceanOfMaya.MathGame) OceanOfMaya.MathGame.setOperation('mixed');
          });
        if (opReset)
          opReset.addEventListener('click', function () {
            if (OceanOfMaya.MathGame) OceanOfMaya.MathGame.resetCounts();
          });

        // Form submission and buttons
        const gameForm = document.getElementById('gameForm');
        const submitAnswer = document.getElementById('submitAnswer');
        const skipQuestion = document.getElementById('skipQuestion');
        const changeMaxNumber = document.getElementById('changeMaxNumber');

        if (gameForm) {
          gameForm.addEventListener('submit', function (e) {
            e.preventDefault();
            if (OceanOfMaya.MathGame) {
              OceanOfMaya.MathGame.validateAnswer();
            }
          });
        }

        if (submitAnswer) {
          submitAnswer.addEventListener('click', function (e) {
            e.preventDefault();
            if (OceanOfMaya.MathGame) {
              OceanOfMaya.MathGame.validateAnswer();
            }
          });
          // Keyboard support: Enter key submits answer
          submitAnswer.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              if (OceanOfMaya.MathGame) {
                OceanOfMaya.MathGame.validateAnswer();
              }
            }
          });
        }

        if (skipQuestion) {
          skipQuestion.addEventListener('click', function () {
            if (OceanOfMaya.MathGame) OceanOfMaya.MathGame.skipQuestion();
          });
          // Keyboard support: Space or Enter skips question
          skipQuestion.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              if (OceanOfMaya.MathGame) OceanOfMaya.MathGame.skipQuestion();
            }
          });
        }

        if (changeMaxNumber) {
          changeMaxNumber.addEventListener('click', function () {
            if (OceanOfMaya.MathGame) OceanOfMaya.MathGame.changeMaxNumber();
          });
        }

        // Sync theme selects
        if (themeSelect && themeSelectSample) {
          themeSelectSample.addEventListener('change', function () {
            themeSelect.value = this.value;
            if (OceanOfMaya.MathGame) {
              OceanOfMaya.MathGame.changeVisualTheme();
            }
          });
          themeSelect.addEventListener('change', function () {
            themeSelectSample.value = this.value;
          });
        }

        // Ensure placeholder is selected on page load (override any browser restore behavior)
        if (themeSelect) {
          themeSelect.value = '';
        }
        if (themeSelectSample) {
          themeSelectSample.value = '';
        }

        // Initialize visual theme system
        // Theme will be initialized when user selects from dropdown (requires user interaction for audio)
        if (OceanOfMaya && OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
          OceanOfMaya.VisualThemes.Manager.sampleMode = false;
          // Don't initialize theme automatically - wait for user selection
          // But update sample element dropdown to reflect current capacity
          OceanOfMaya.VisualThemes.Manager.updateSampleElementDropdown();
        }

        // Initialize game
        if (OceanOfMaya.MathGame) {
          OceanOfMaya.MathGame.setOperation(Constants.DEFAULT_OPERATION);
          OceanOfMaya.MathGame.refreshCount();
        }

        // Display version
        const versionDisplay = document.getElementById('version-display');
        if (versionDisplay && Constants.VERSION) {
          versionDisplay.textContent = `v${Constants.VERSION}`;
        }

        // Help toggle button
        const helpToggle = document.getElementById('helpToggle');
        const helpContent = document.getElementById('helpContent');

        if (helpToggle && helpContent) {
          // Initialize help button to inactive (greyed out) since content is hidden by default
          helpToggle.classList.add('inactive');

          helpToggle.addEventListener('click', function () {
            const isHidden = helpContent.classList.toggle('hidden');
            // Toggle active state: blue when shown, grey when hidden
            if (isHidden) {
              helpToggle.classList.remove('active');
              helpToggle.classList.add('inactive');
              helpToggle.setAttribute('aria-expanded', 'false');
            } else {
              helpToggle.classList.remove('inactive');
              helpToggle.classList.add('active');
              helpToggle.setAttribute('aria-expanded', 'true');
              // Update content based on current mode when showing
              updateHelpContent();
            }
          });
          // Keyboard support for help toggle
          helpToggle.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              helpToggle.click();
            }
          });
        }

        // Initialize button states
        if (gameButton && sampleButton) {
          gameButton.classList.add('active');
          gameButton.classList.remove('inactive');
          sampleButton.classList.add('inactive');
          sampleButton.classList.remove('active');
        }

        // Initialize timed mode button to inactive
        const timedModeButtonInit = document.getElementById('timedModeButton');
        if (timedModeButtonInit) {
          timedModeButtonInit.classList.add('inactive');
          timedModeButtonInit.classList.remove('active');
        }

        // Initialize help content to show game mode by default
        updateHelpContent();

        // Initialize mode visibility - use classes only, no inline styles
        const gameFields = document.querySelectorAll('.game-mode-fields');
        gameFields.forEach((field) => {
          if (field) {
            field.classList.remove('hidden');
          }
        });
        const sampleFields = document.getElementById('sampleModeFields');
        if (sampleFields) {
          sampleFields.classList.add('hidden');
          sampleFields.classList.remove('visible');
        }
        const countContainer = document.querySelector('.count-container');
        if (countContainer) {
          countContainer.classList.remove('hidden');
        }

        // Initialize sound manager
        if (OceanOfMaya.Sound && OceanOfMaya.Sound.Manager) {
          OceanOfMaya.Sound.Manager.initialize();

          // Set up music toggle button
          const musicToggleButton = document.getElementById('musicToggleButton');
          if (musicToggleButton) {
            // Initialize button state based on current mute status
            if (OceanOfMaya.Sound.Manager.isMuted) {
              musicToggleButton.classList.add('inactive');
            } else {
              musicToggleButton.classList.add('active');
            }

            // Define the click handler function
            const handleMusicToggle = function () {
              const isMuted = OceanOfMaya.Sound.Manager.toggleMute();
              musicToggleButton.title = isMuted ? 'Enable theme music' : 'Disable theme music';
              musicToggleButton.setAttribute('aria-pressed', isMuted ? 'false' : 'true');
              // Update button styling based on mute state (colors indicate state, icon stays the same)
              if (isMuted) {
                musicToggleButton.classList.add('inactive');
                musicToggleButton.classList.remove('active');
              } else {
                musicToggleButton.classList.add('active');
                musicToggleButton.classList.remove('inactive');
              }

              // Announce state change to screen readers
              const liveRegion = document.getElementById('ariaLiveRegion');
              if (liveRegion) {
                liveRegion.textContent = isMuted ? 'Theme music disabled' : 'Theme music enabled';
              }

              // If unmuted and theme is set, resume music
              if (
                !isMuted &&
                OceanOfMaya.VisualThemes &&
                OceanOfMaya.VisualThemes.Manager &&
                OceanOfMaya.VisualThemes.Manager.currentTheme
              ) {
                // Get current theme name from select element
                const themeSelect =
                  document.getElementById('visualThemeSelect') || document.getElementById('visualThemeSelectSample');
                if (themeSelect) {
                  OceanOfMaya.Sound.Manager.playThemeMusic(themeSelect.value);
                }
              }
            };

            // Add click and keyboard support
            musicToggleButton.addEventListener('click', handleMusicToggle);
            musicToggleButton.addEventListener('keydown', function (e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleMusicToggle();
              }
            });
          }

          // Enable music after user interaction (required for autoplay)
          // Only plays if a theme has been selected
          const enableMusicAfterInteraction = function () {
            if (OceanOfMaya.VisualThemes && OceanOfMaya.VisualThemes.Manager) {
              const themeSelect =
                document.getElementById('visualThemeSelect') || document.getElementById('visualThemeSelectSample');
              if (themeSelect && themeSelect.value) {
                // Only play music if a theme is actually selected
                OceanOfMaya.Sound.Manager.playThemeMusic(themeSelect.value);
              }
            }
            // Remove listeners after first interaction
            document.removeEventListener('click', enableMusicAfterInteraction);
            document.removeEventListener('keydown', enableMusicAfterInteraction);
          };

          document.addEventListener('click', enableMusicAfterInteraction, { once: true });
          document.addEventListener('keydown', enableMusicAfterInteraction, { once: true });
        }

        // Timed mode controls
        const timedModeButton = document.getElementById('timedModeButton');

        if (timedModeButton) {
          addKeyboardSupport(timedModeButton, function () {
            if (OceanOfMaya.MathGame) {
              OceanOfMaya.MathGame.toggleTimedMode();
            }
          });
        }

        // Mobile keyboard handling with body scrolling (avoid nested scroll containers)
        // Uses visualViewport when available for reliable keyboard detection
        if ('scrollRestoration' in history) {
          history.scrollRestoration = 'manual';
        }
        // Ensure we start at the top on page load (and after bfcache restores)
        window.addEventListener('pageshow', function () {
          setTimeout(function () {
            window.scrollTo(0, 0);
          }, 0);
        });

        const form = document.getElementById('gameForm');
        const visualViewport = window.visualViewport || null;
        let initialViewportHeight = visualViewport ? visualViewport.height : window.innerHeight;
        let keyboardWasVisible = false;
        let scrollToTopTimeout = null;

        function getViewportHeight() {
          return visualViewport ? visualViewport.height : window.innerHeight;
        }

        function scrollInputIntoView(input) {
          if (!input) return;
          // Defer to allow keyboard to animate in
          setTimeout(function () {
            const viewportHeight = getViewportHeight();
            const padding = 20;
            const rect = input.getBoundingClientRect();
            if (rect.bottom > viewportHeight - padding) {
              const currentScrollY = window.pageYOffset || document.documentElement.scrollTop || 0;
              const delta = rect.bottom - (viewportHeight - padding);
              const targetY = Math.max(0, currentScrollY + delta);
              window.scrollTo({ top: targetY, behavior: 'auto' });
            }
          }, 300);
        }

        function scrollToTop() {
          if (scrollToTopTimeout) {
            clearTimeout(scrollToTopTimeout);
          }
          // Small delay to let keyboard dismissal finish
          scrollToTopTimeout = setTimeout(function () {
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }, 100);
        }

        // Handle answer input focus
        const answerInput = document.getElementById('answer');
        if (answerInput) {
          answerInput.addEventListener('focus', function () {
            scrollInputIntoView(this);
          });
        }

        // Handle max number input focus
        const maxNumberInputForScroll = document.getElementById('maxNumber');
        if (maxNumberInputForScroll) {
          maxNumberInputForScroll.addEventListener('focus', function () {
            scrollInputIntoView(this);
          });
        }

        // Handle viewport resize (keyboard appearing/disappearing)
        function handleViewportResize() {
          const currentHeight = getViewportHeight();
          const heightDifference = initialViewportHeight - currentHeight;

          // Keyboard appeared
          if (heightDifference > 150) {
            keyboardWasVisible = true;
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.id === 'answer' || activeElement.id === 'maxNumber')) {
              scrollInputIntoView(activeElement);
            }
          }
          // Keyboard dismissed
          else if (keyboardWasVisible && currentHeight >= initialViewportHeight - 10) {
            keyboardWasVisible = false;
            initialViewportHeight = currentHeight;
            scrollToTop();
          }
        }
        if (visualViewport) {
          visualViewport.addEventListener('resize', handleViewportResize);
        } else {
          window.addEventListener('resize', handleViewportResize);
        }

        // Also handle blur events to scroll back to top when input loses focus
        // This catches cases where keyboard is dismissed by tapping outside
        // The blur handler acts as a backup in case resize events don't fire reliably
        function handleInputBlur() {
          // Use a delay to allow resize event to fire first (more reliable on iOS)
          setTimeout(function () {
            if (keyboardWasVisible) {
              const currentHeight = getViewportHeight();
              if (currentHeight >= initialViewportHeight - 10) {
                keyboardWasVisible = false;
                initialViewportHeight = currentHeight;
                scrollToTop();
              }
            }
          }, 300);
        }

        if (answerInput) {
          answerInput.addEventListener('blur', handleInputBlur);
        }

        if (maxNumberInputForScroll) {
          maxNumberInputForScroll.addEventListener('blur', handleInputBlur);
        }
      });
    </script>
  </body>
</html>
